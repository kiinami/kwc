{% extends 'base.html' %}
{% block title %}Job · KWC{% endblock %}
{% block content %}
<style>
  .job-shell {
    min-height: 60vh;
    display: grid;
    place-items: center;
    padding: 0 clamp(1rem, 4vw, 2rem) 2rem;
    box-sizing: border-box;
  }

  .job-card {
    max-width: 720px;
    width: 100%;
  }

  @media (max-width: 768px) {
    .job-card {
      padding-inline: clamp(1rem, 6vw, 1.75rem);
      box-sizing: border-box;
    }
  }
</style>
<div class="job-shell">
  <div class="card job-card">
    <h1 style="margin-top:0">{% if job_name %}{{ job_name }}{% else %}Extraction{% endif %}</h1>

    <div style="display:flex; align-items:center; gap:.5rem; margin-top:.75rem;">
      <span id="statusBadge" class="status status--{{ status_class }}">{{ status_label }}</span>
    </div>
    <div id="errorMessage" style="margin-top:.75rem; color:#fca5a5; {% if not is_error %}display:none{% endif %}">{{ error_message }}</div>

    <div id="progress" style="margin-top: .75rem; {% if is_done %}display:none{% endif %}">
      <div style="background: rgba(255,255,255,0.08); border-radius: .6rem; overflow: hidden;">
        <div id="bar" style="height: 12px; width: {{ percent }}%; background: linear-gradient(135deg, #4c8bf5, #7c4cf5);"></div>
      </div>
      <div class="muted" style="margin-top: .5rem;">
        <span id="counts">
          <span id="countsNumbers" {% if not total %}style="display:none"{% endif %}>
            <span id="current">{{ current|default_if_none:0 }}</span> / <span id="total">{{ total|default_if_none:0 }}</span>
          </span>
          <span id="countsUnknown" {% if total %}style="display:none"{% endif %}>Getting total frames…</span>
        </span>
        (<span id="percent">{{ percent }}</span>%) — <span id="elapsed">{{ elapsed|floatformat:1 }}</span>s
      </div>
    </div>

    <div id="summary" style="margin-top: 1rem; {% if not is_done %}display:none{% endif %}">
      <h3>Summary</h3>
      <ul class="muted">
        <li>Total frames: <span id="frames">{{ results.total_frames }}</span></li>
        <li>Time taken: <span id="time">{{ results.time_taken }}</span></li>
        <li>Output dir: {{ results.output_dir }}</li>
      </ul>
    </div>

    <div style="margin-top: 1rem;">
      <a class="btn btn-ghost" href="{% url 'extract:index' %}">Back</a>
      <button class="btn btn-ghost" id="cancelBtn" style="{% if is_finished %}display:none{% endif %}; color:#fca5a5; border-color:#fca5a5;" {% if status == 'cancelling' %}disabled{% endif %}>{% if status == 'cancelling' %}Cancelling...{% else %}Cancel{% endif %}</button>
      <a class="btn btn-primary" id="chooseBtn" href="{{ gallery_url }}" style="{% if not is_done %}display:none{% endif %}">Curate in Inbox</a>
    </div>
  </div>
</div>
<script>
  const apiUrl = "{% url 'extract:job_api' job_id=job_id %}";
  const cancelUrl = "{% url 'extract:cancel_job' job_id=job_id %}";
  const statusBadge = document.getElementById('statusBadge');
  const bar = document.getElementById('bar');
  const percentEl = document.getElementById('percent');
  const currentEl = document.getElementById('current');
  const totalEl = document.getElementById('total');
  const elapsedEl = document.getElementById('elapsed');
  const chooseBtn = document.getElementById('chooseBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const progress = document.getElementById('progress');
  const summary = document.getElementById('summary');
  const framesEl = document.getElementById('frames');
  const timeEl = document.getElementById('time');
  const countsNumbers = document.getElementById('countsNumbers');
  const countsUnknown = document.getElementById('countsUnknown');
  const errorEl = document.getElementById('errorMessage');

  // Cancel button handler
  if (cancelBtn) {
    cancelBtn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to cancel this extraction job?')) {
        return;
      }
      
      cancelBtn.disabled = true;
      cancelBtn.textContent = 'Cancelling...';
      
      try {
        const res = await fetch(cancelUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
          },
        });
        
        if (res.ok) {
          const data = await res.json();
          if (data.success) {
            // Poll immediately to update UI
            setTimeout(poll, 100);
          } else {
            alert('Failed to cancel: ' + (data.error || 'Unknown error'));
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'Cancel';
          }
        } else {
          alert('Failed to cancel job');
          cancelBtn.disabled = false;
          cancelBtn.textContent = 'Cancel';
        }
      } catch (e) {
        alert('Error cancelling job: ' + e.message);
        cancelBtn.disabled = false;
        cancelBtn.textContent = 'Cancel';
      }
    });
  }

  // CSRF token helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function poll() {
    try {
      const res = await fetch(apiUrl, {cache: 'no-store'});
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();
      if (statusBadge) {
        statusBadge.textContent = data.status_label || data.status || '';
        statusBadge.className = `status status--${data.status_class || 'pending'}`;
      }
      if (errorEl) {
        if (data.error) {
          errorEl.textContent = data.error;
          errorEl.style.display = '';
        } else {
          errorEl.textContent = '';
          errorEl.style.display = 'none';
        }
      }

      const pct = Number.isFinite(data.percent) ? Math.max(0, Math.min(100, data.percent)) : 0;
      if (bar) bar.style.width = pct + '%';
      if (percentEl) percentEl.textContent = Math.round(pct);

      if (data.total != null && data.current != null) {
        if (countsNumbers) countsNumbers.style.display = '';
        if (countsUnknown) countsUnknown.style.display = 'none';
        if (currentEl) currentEl.textContent = data.current;
        if (totalEl) totalEl.textContent = data.total;
      } else {
        if (countsNumbers) countsNumbers.style.display = 'none';
        if (countsUnknown) countsUnknown.style.display = '';
      }

      if (elapsedEl && data.elapsed_seconds != null) {
        elapsedEl.textContent = Number(data.elapsed_seconds).toFixed(1);
      }
      if (framesEl && data.total_frames != null) framesEl.textContent = data.total_frames;
      if (timeEl && data.time_taken) timeEl.textContent = data.time_taken;

      const finished = !!data.finished;
      const done = !!data.done;
      const isCancelling = data.status === 'cancelling';

      if (progress) progress.style.display = finished ? 'none' : '';
      if (summary) summary.style.display = done ? '' : 'none';
      if (chooseBtn) chooseBtn.style.display = done ? '' : 'none';
      if (cancelBtn) {
        cancelBtn.style.display = finished ? 'none' : '';
        if (isCancelling) {
          cancelBtn.disabled = true;
          cancelBtn.textContent = 'Cancelling...';
        }
      }

      if (finished) {
        return;
      }
    } catch (e) { /* ignore */ }
    setTimeout(poll, 1000);
  }
  // Only poll if not done
  {% if not is_finished %}poll();{% endif %}
</script>
{% endblock %}
