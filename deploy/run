#!/usr/bin/env bash
set -euo pipefail

cmd="${1:-serve}"

: "${DJANGO_SETTINGS_MODULE:=kwc.settings}"
: "${PORT:=8000}"

case "$cmd" in
  serve|prod)
    # Persist SQLite DB if a /data volume is mounted
    if [[ -d /data ]]; then
      echo "[entrypoint] Ensuring persistent DB at /data/db.sqlite3"
      ln -sf /data/db.sqlite3 /app/db.sqlite3
    fi

    echo "[entrypoint] Applying migrations..."
    python manage.py migrate --noinput

    echo "[entrypoint] Starting Django development server on 0.0.0.0:${PORT} (insecure, internal use only)"
    exec python manage.py runserver 0.0.0.0:"${PORT}"
    ;;

  migrate)
    exec python manage.py migrate --noinput
    ;;

  manage|django)
    shift || true
    exec python manage.py "$@"
    ;;

  *)
    exec "$@"
    ;;
esac
