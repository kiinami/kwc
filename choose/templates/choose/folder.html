{% extends 'base.html' %}
{% block title %}{{ folder }} · Choose · KWC{% endblock %}
{% block content %}
  <style>
  /* Page-local: disable body vertical scroll so only sidebar can scroll */
  html { height: 100%; overflow: hidden; overscroll-behavior: none; }
  body { overflow: hidden; overscroll-behavior: none; }
    /* Remove extra vertical padding added by base .content on this page */
    .content { padding-top: 0 !important; padding-bottom: 0 !important; }
    /* Full-bleed wrapper that escapes the base .container width without touching other pages */
    .fullbleed {
      position: relative;
      left: 50%;
      right: 50%;
      margin-left: -50vw;
      margin-right: -50vw;
      width: 100vw;
      max-width: 100vw;
      box-sizing: border-box; /* include padding in width to avoid overflow */
      overflow-x: hidden; /* guard against sub-pixel overflow */
      padding-left: 0;
      padding-right: 0;
    }
    @media (min-width: 1024px) {
      .fullbleed { padding-left: 0; padding-right: 0; }
    }
  .chooser-layout { display: grid; grid-template-columns: 300px 1fr; gap: 0; height: calc(100vh - var(--nav-height, 72px)); min-height: calc(100vh - var(--nav-height, 72px)); overflow: hidden; }
  .chooser-layout.sidebar-hidden { grid-template-columns: 1fr; }
  .chooser-sidebar { border-right: 1px solid rgba(255,255,255,0.08); display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease; }
  .chooser-layout.sidebar-hidden .chooser-sidebar { transform: translateX(-100%); position: absolute; z-index: 10; }
  .sidebar-header { display: grid; gap: .25rem; padding: .6rem .6rem; border-bottom: 1px solid rgba(255,255,255,0.08); flex: 0 0 auto; }
  .sidebar-title { font-weight: 700; line-height: 1.25; white-space: normal; overflow: visible; text-overflow: initial; word-break: break-word; }
  .sidebar-count { color: var(--muted); font-size: .9rem; }
  .sidebar-list { overflow-y: auto; padding: .5rem; flex: 1 1 auto; }
  .chooser-viewport { position: relative; overflow: hidden; touch-action: none; overscroll-behavior: none; }
  .thumb { position: relative; border-radius: .5rem; overflow: hidden; margin-bottom: .75rem; background: rgba(255,255,255,0.06); cursor: pointer; }
  /* Hover hint only for undecided and not active */
  .thumb:hover:not(.active):not(.keep):not(.delete) { outline: 3px solid rgba(124,76,245,0.35); }
  /* Persistent decisions */
  .thumb.keep { outline: 4px solid #22c55e; }
  .thumb.delete { outline: 4px solid #ef4444; }
  /* Active selection always shows blue border and takes precedence */
  .thumb.active { outline: 5px solid rgba(124,76,245,0.95); }
    .thumb-img { width: 100%; aspect-ratio: 16 / 9; object-fit: cover; display: block; }
    .thumb.loading .thumb-img { opacity: .2; }
  .thumb .spinner { position: absolute; inset: 0; display: grid; place-items: center; }
  .viewport-inner .spinner { position: absolute; inset: 0; display: grid; place-items: center; }
    .thumb:not(.loading) .spinner { display: none; }
    .spinner::before { content: ""; width: 20px; height: 20px; border-radius: 999px; border: 2px solid rgba(255,255,255,0.35); border-top-color: #fff; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  .viewport-inner { width: 100%; height: calc(100% - 46px); display: flex; align-items: center; justify-content: center; box-sizing: border-box; padding: 0; }
  .viewport-img { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display: block; opacity: 0; transition: opacity .25s ease; border-radius: .6rem; }
    .viewport-img.loaded { opacity: 1; }
  
  .toggle-sidebar-btn { position: absolute; top: 1rem; left: 1rem; width: 2.5rem; height: 2.5rem; border-radius: .5rem; border: 1px solid rgba(255,255,255,0.18); background: rgba(26,32,56,0.85); color: #fff; display: grid; place-items: center; font-size: 1.2rem; cursor: pointer; transition: all 0.15s ease; z-index: 5; }
  .toggle-sidebar-btn:hover { background: rgba(44,52,88,0.9); border-color: rgba(255,255,255,0.35); }
  
  .mobile-swipe-hint,
  .mobile-decision-badge,
  .mobile-save,
  .mobile-undo { display: none; }
    @media (max-width: 900px) {
      .chooser-layout { grid-template-columns: 1fr; height: calc(100vh - var(--nav-height, 72px)); min-height: calc(100vh - var(--nav-height, 72px)); }
      .chooser-sidebar { order: 2; max-height: 40vh; }
      .chooser-viewport { order: 1; min-height: 50vh; }
      .toggle-sidebar-btn { display: none; }
    }
    @media (max-width: 768px) {
      .fullbleed { padding-left: 0; padding-right: 0; }
      .chooser-layout { grid-template-columns: 1fr; height: calc(100vh - var(--nav-height, 72px)); min-height: calc(100vh - var(--nav-height, 72px)); }
      .chooser-sidebar { display: none; }
      .chooser-viewport { height: calc(100vh - var(--nav-height, 72px)); }
      .viewport-inner { height: 100%; padding: 0; }
      .desktop-controls { display: none !important; }
      .toggle-sidebar-btn { display: none; }
  .mobile-save { display: inline-flex; position: absolute; top: 1rem; right: 1rem; z-index: 5; }
  .mobile-undo { display: inline-flex; position: absolute; top: 1rem; left: 1rem; z-index: 5; }
      .mobile-swipe-hint { display: flex; position: absolute; bottom: 1.4rem; left: 50%; transform: translateX(-50%); gap: .75rem; background: rgba(10,10,10,0.65); border-radius: 999px; padding: .55rem 1.2rem; font-size: .9rem; color: rgba(255,255,255,0.85); text-transform: uppercase; letter-spacing: .05em; transition: opacity .3s ease; z-index: 4; }
      .mobile-swipe-hint span { white-space: nowrap; }
      .mobile-swipe-hint.dismissed { opacity: 0; pointer-events: none; }
      .mobile-decision-badge { display: block; position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%); padding: .75rem 1.35rem; border-radius: 999px; font-weight: 700; letter-spacing: .05em; text-transform: uppercase; background: rgba(0,0,0,0.75); color: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.35); opacity: 0; transition: opacity .2s ease; pointer-events: none; z-index: 6; }
      .mobile-decision-badge.active { opacity: .95; }
      .mobile-decision-badge.keep { background: rgba(34,197,94,0.9); }
      .mobile-decision-badge.delete { background: rgba(239,68,68,0.9); }
    }

    @supports (height: 100dvh) {
      .chooser-layout { height: calc(100dvh - var(--nav-height, 72px)); min-height: calc(100dvh - var(--nav-height, 72px)); }
      .chooser-viewport { height: calc(100dvh - var(--nav-height, 72px)); }
    }

  /* Modal */
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
  .modal-backdrop.show { display: flex; }
  .modal { background: var(--panel, #111319); border: 1px solid rgba(255,255,255,0.08); border-radius: .75rem; width: min(520px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,0.45); }
  .modal header { padding: .9rem 1rem; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.08); }
  .modal .body { padding: 1rem; color: var(--muted); }
  .modal .body p { margin: .5rem 0; }
  .modal footer { display: flex; gap: .5rem; justify-content: flex-end; padding: .8rem 1rem; border-top: 1px solid rgba(255,255,255,0.08); }
  </style>

  <div class="fullbleed">
  <div class="chooser-layout" data-is-inbox="{{ is_inbox|yesno:'true,false' }}">
    <aside class="chooser-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">{{ folder }}</div>
        <div class="sidebar-count">{{ images|length }} images</div>
        {% if images %}
        <div>
          <button id="btnOpenSave" class="btn btn-ghost" type="button" title="Apply decisions and rename">Save…</button>
        </div>
        {% endif %}
      </div>
      <div class="sidebar-list">
        {% if images %}
          {% for img in images %}
            <div class="thumb loading{% if forloop.counter0 == selected_index %} active{% endif %}{% if img.decision %} {{ img.decision }}{% endif %}" data-index="{{ forloop.counter0 }}" data-url="{{ img.url }}" data-name="{{ img.name|escape }}" data-decision="{{ img.decision }}" title="{{ img.name }}">
              <div class="spinner"></div>
              <img class="thumb-img" src="{{ img.thumb_url|default:img.url }}" alt="{{ img.name }}" loading="lazy" onload="this.closest('.thumb').classList.remove('loading')" />
            </div>
          {% endfor %}
        {% else %}
          <p class="muted" style="padding:.5rem;">No images in this folder.</p>
        {% endif %}
      </div>
    </aside>
    <section class="chooser-viewport">
      <div class="viewport-inner">
        {% if images %}
          <div id="mainSpinner" class="spinner" aria-hidden="true"></div>
          <img id="mainImage" class="viewport-img" src="{{ selected_image_url }}" alt="{{ selected_image_name }}" onload="this.classList.add('loaded'); document.getElementById('mainSpinner')?.remove();" />
        {% else %}
          <div class="muted">No image selected</div>
        {% endif %}
      </div>
      {% if images %}
      <button id="toggleSidebarBtn" class="toggle-sidebar-btn" type="button" aria-label="Toggle sidebar" title="Toggle sidebar (S)">☰</button>
      <button id="btnUndoMobile" class="btn btn-ghost mobile-undo" type="button" aria-label="Undo last decision">Undo</button>
      <button id="btnOpenSaveMobile" class="btn btn-primary mobile-save" type="button" aria-label="Apply decisions and rename">Save…</button>
      <div id="mobileDecisionBadge" class="mobile-decision-badge" aria-hidden="true"></div>
      <div class="mobile-swipe-hint" aria-hidden="true">
        <span>Swipe left to delete</span>
        <span>Swipe right to keep</span>
      </div>
      <div class="desktop-controls" style="position:absolute; bottom:.75rem; left:50%; transform:translateX(-50%); display:flex; align-items:center; gap:.5rem;">
        <button id="btnUndo" class="btn btn-ghost" type="button" title="Undo last decision">Undo</button>
        <button id="btnDelete" class="btn btn-ghost" type="button" title="Delete (D)" style="border-color: rgba(239,68,68,.6); color:#fff;">Delete</button>
        <button id="btnKeep" class="btn btn-primary" type="button" title="Keep (K)">Keep</button>
      </div>
      {% endif %}
    </section>
  </div>
  </div>

  <!-- Save confirmation modal -->
  <div id="saveModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="saveTitle">
      <header id="saveTitle">Apply and Save</header>
      <div class="body">
        <p>You're about to apply your choices to this folder.</p>
        
        <style>
          .save-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
          }
          .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 1rem 0.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
          }
          .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
          }
          .stat-label {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
             letter-spacing: 0.5px;
            font-weight: 600;
          }
          .stat-card.keep { border-color: rgba(34, 197, 94, 0.2); background: rgba(34, 197, 94, 0.05); }
          .stat-card.keep .stat-value { color: var(--state-done); }
          
          .stat-card.delete { border-color: rgba(239, 68, 68, 0.2); background: rgba(239, 68, 68, 0.05); }
          .stat-card.delete .stat-value { color: var(--state-error); }
          
          .stat-card.undecided .stat-value { color: var(--text); }
        </style>

        <div class="save-stats-grid">
          <div class="stat-card keep">
            <span class="stat-value" id="saveKeepCount">0</span>
            <span class="stat-label">Save</span>
          </div>
          <div class="stat-card delete">
            <span class="stat-value" id="saveDeleteCount">0</span>
            <span class="stat-label">Discard</span>
          </div>
          <div class="stat-card undecided">
            <span class="stat-value" id="saveUndecidedCount">0</span>
            <span class="stat-label">Left</span>
          </div>
        </div>
      </div>
      <footer>
        <button id="btnCancelSave" class="btn btn-ghost" type="button">Cancel</button>
        <button id="btnConfirmSave" class="btn btn-primary" type="button">Continue</button>
      </footer>
    </div>
  </div>

  <script>
    (function(){
      const isInbox = document.querySelector('.chooser-layout').dataset.isInbox === 'true';
      const thumbs = Array.from(document.querySelectorAll('.thumb'));
      const main = document.getElementById('mainImage');
      const sidebar = document.querySelector('.sidebar-list');
      const chooserLayout = document.querySelector('.chooser-layout');
      const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
      const btnKeep = document.getElementById('btnKeep');
      const btnDelete = document.getElementById('btnDelete');
      const btnOpenSave = document.getElementById('btnOpenSave');
      const btnOpenSaveMobile = document.getElementById('btnOpenSaveMobile');
      const btnUndo = document.getElementById('btnUndo');
      const btnUndoMobile = document.getElementById('btnUndoMobile');
      const saveModal = document.getElementById('saveModal');
      const btnCancelSave = document.getElementById('btnCancelSave');
      const btnConfirmSave = document.getElementById('btnConfirmSave');
      const keepCountEl = document.getElementById('saveKeepCount');
      const deleteCountEl = document.getElementById('saveDeleteCount');
      const undecidedCountEl = document.getElementById('saveUndecidedCount');
      const decisionBadge = document.getElementById('mobileDecisionBadge');
      const swipeHint = document.querySelector('.mobile-swipe-hint');
      const mobileMedia = window.matchMedia('(max-width: 768px)');
      const decisionHistory = [];
      const PREFETCH_AHEAD = 2;
      const PRELOAD_MAX = 16;
      const preloadCache = new Map();
      const preloadQueue = [];

      function registerPreload(url, image) {
        if (!url) return;
        if (preloadCache.has(url)) {
          return;
        }
        preloadCache.set(url, image);
        preloadQueue.push(url);
        if (preloadQueue.length > PRELOAD_MAX) {
          const oldest = preloadQueue.shift();
          if (oldest && oldest !== url) {
            preloadCache.delete(oldest);
          }
        }
      }

      function preloadImage(url) {
        if (!url || preloadCache.has(url)) return;
        const img = new Image();
        img.decoding = 'async';
        img.src = url;
        registerPreload(url, img);
      }

      function preloadNeighbors(index) {
        if (!Number.isFinite(index)) return;
        for (let offset = 1; offset <= PREFETCH_AHEAD; offset += 1) {
          const nextEl = thumbs[index + offset];
          const prevEl = thumbs[index - offset];
          if (nextEl) preloadImage(nextEl.dataset.url);
          if (prevEl) preloadImage(prevEl.dataset.url);
        }
      }

      function updateUndoState() {
        const disabled = decisionHistory.length === 0;
        if (btnUndo) btnUndo.disabled = disabled;
        if (btnUndoMobile) btnUndoMobile.disabled = disabled;
      }

      updateUndoState();

      // Sidebar toggle
      if (toggleSidebarBtn && chooserLayout) {
        toggleSidebarBtn.addEventListener('click', function() {
          chooserLayout.classList.toggle('sidebar-hidden');
        });
      }

      function activateThumb(el) {
        if (!el) return;
        const url = el.dataset.url;
        const filename = el.dataset.name || '';
        const index = Number.parseInt(el.dataset.index || '0', 10) || 0;
        const preloaded = url ? preloadCache.get(url) : undefined;
        const alreadyLoaded = Boolean(preloaded && preloaded.complete);
        // Update active state
        document.querySelectorAll('.thumb.active').forEach(a => a.classList.remove('active'));
        el.classList.add('active');
        // Ensure selected is centered in sidebar
        el.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'smooth' });
        if (main && url) {
          if (!alreadyLoaded) {
            main.classList.remove('loaded');
          }
          main.style.transition = '';
          main.style.transform = '';
          if (decisionBadge) {
            decisionBadge.classList.remove('active', 'keep', 'delete');
            decisionBadge.style.opacity = '0';
          }
          // show spinner
          let sp = document.getElementById('mainSpinner');
          if (!alreadyLoaded) {
            if (!sp) {
              sp = document.createElement('div');
              sp.id = 'mainSpinner';
              sp.className = 'spinner';
              main.parentElement?.appendChild(sp);
            }
          } else {
            sp?.remove();
          }
          const onLoad = () => {
            main.classList.add('loaded');
            sp?.remove();
            main.removeEventListener('load', onLoad);
            main.style.transition = '';
            main.style.transform = '';
            if (decisionBadge) {
              decisionBadge.classList.remove('active', 'keep', 'delete');
              decisionBadge.style.opacity = '0';
            }
          };
          main.src = url;
          main.alt = filename || 'image';
          if (alreadyLoaded) {
            if (typeof main.decode === 'function') {
              main.decode().then(onLoad).catch(onLoad);
            } else if (main.complete) {
              onLoad();
            } else {
              main.addEventListener('load', onLoad, { once: true });
            }
          } else {
            main.addEventListener('load', onLoad, { once: true });
          }
          preloadNeighbors(index);
        }
      }

      // On load, ensure the initially active item is centered
      (function(){
        const current = document.querySelector('.thumb.active');
        if (current) current.scrollIntoView({ block: 'center', inline: 'nearest' });
        if (current) {
          const currentIndex = Number.parseInt(current.dataset.index || '0', 10);
          if (Number.isFinite(currentIndex)) {
            preloadNeighbors(currentIndex);
          }
        }
      })();

      // Mouse selection
      thumbs.forEach(el => {
        el.addEventListener('click', () => activateThumb(el));
      });

      // Keyboard navigation: ArrowUp / ArrowDown
      window.addEventListener('keydown', (e) => {
        if (saveModal && saveModal.classList.contains('show')) {
          // Don't handle shortcuts when modal is open
          return;
        }
        if (e.key === 's' || e.key === 'S') {
          e.preventDefault();
          if (chooserLayout) chooserLayout.classList.toggle('sidebar-hidden');
          return;
        }
        if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') return;
        e.preventDefault();
        const current = document.querySelector('.thumb.active');
        let idx = current ? parseInt(current.getAttribute('data-index') || '0', 10) : 0;
        if (Number.isNaN(idx)) idx = 0;
        if (e.key === 'ArrowUp') idx = Math.max(0, idx - 1);
        if (e.key === 'ArrowDown') idx = Math.min(thumbs.length - 1, idx + 1);
        const target = thumbs[idx];
        activateThumb(target);
      });

      function getCsrf(){
        const name = 'csrftoken=';
        const cookie = document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith(name));
        return cookie ? decodeURIComponent(cookie.substring(name.length)) : '';
      }

      async function persistDecision(filename, decision) {
        if (!filename) return;
        try {
          const res = await fetch(`${window.location.pathname}decide`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() },
            body: JSON.stringify({ filename, decision })
          });
          if (!res.ok) throw new Error('request_failed');
        } catch (e) {
          console.error('Failed to save decision', e);
        }
      }

      function undoDecision(){
        const entry = decisionHistory.pop();
        if (!entry) { updateUndoState(); return; }
        const thumb = entry.thumb || entry;
        if (!thumb) { updateUndoState(); return; }
        thumb.classList.remove('keep', 'delete');
        thumb.dataset.decision = '';
        activateThumb(thumb);
        persistDecision(thumb.dataset.name || '', '');
        updateUndoState();
      }

      async function decide(decision){
        const active = document.querySelector('.thumb.active');
        if (!active) return;
        const filename = active.dataset.name || '';

        decisionHistory.push({ thumb: active });
        updateUndoState();

        // Optimistically mark decision on current thumb
        active.classList.remove('keep','delete');
        active.classList.add(decision);
        active.dataset.decision = decision;

        // Compute next and advance immediately for fast workflow
        let idx = parseInt(active.getAttribute('data-index') || '0', 10);
        if (Number.isNaN(idx)) idx = 0;
        const next = thumbs[idx + 1];
        if (next) {
          activateThumb(next);
        } else {
          // No more images after this one - open save dialog
          openSaveModal();
        }

        // Persist in background
        persistDecision(filename, decision);
      }

      btnKeep?.addEventListener('click', () => decide('keep'));
      btnDelete?.addEventListener('click', () => decide('delete'));
      window.addEventListener('keydown', (e) => {
        if (saveModal && saveModal.classList.contains('show')) {
          // Don't handle shortcuts when modal is open
          return;
        }
        if (e.key === 'k' || e.key === 'K') { e.preventDefault(); decide('keep'); }
        if (e.key === 'd' || e.key === 'D') { e.preventDefault(); decide('delete'); }
        if (e.key === 'u' || e.key === 'U') { e.preventDefault(); undoDecision(); }
      });
      btnOpenSaveMobile?.addEventListener('click', openSaveModal);
      btnUndo?.addEventListener('click', undoDecision);
      btnUndoMobile?.addEventListener('click', undoDecision);

      function openSaveModal(){
        // Compute counts from current DOM state
        const total = thumbs.length;
        const deletes = thumbs.filter(t => t.classList.contains('delete')).length;
        const keeps = thumbs.filter(t => t.classList.contains('keep')).length;
        const undecided = total - deletes - keeps;
        
        keepCountEl.textContent = String(keeps);
        deleteCountEl.textContent = String(deletes);
        if (undecidedCountEl) undecidedCountEl.textContent = String(undecided);
        saveModal?.classList.add('show');
      }
      function closeSaveModal(){ saveModal?.classList.remove('show'); }

      btnOpenSave?.addEventListener('click', openSaveModal);
      btnCancelSave?.addEventListener('click', closeSaveModal);
      saveModal?.addEventListener('click', (e) => { if (e.target === saveModal) closeSaveModal(); });

      btnConfirmSave?.addEventListener('click', async () => {
        btnConfirmSave.disabled = true;
        btnConfirmSave.textContent = 'Applying…';
        try {
          const url = `${window.location.pathname}save` + (isInbox ? '?mode=inbox' : '');
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrf() },
          });
          if (!res.ok) throw new Error('request_failed');
          // Redirect to appropriate page
          if (isInbox) {
            window.location.assign('{% url "choose:inbox" %}');
          } else {
            window.location.assign(`${window.location.pathname}gallery/`);
          }
        } catch (e) {
          console.error('Save failed', e);
          alert('Saving failed. Please try again.');
          btnConfirmSave.disabled = false;
          btnConfirmSave.textContent = 'Continue';
        }
      });

      if (main) {
        let pointerId = null;
        let startX = 0;
        let startY = 0;
        let startTime = 0;
        let dragging = false;
        const SWIPE_THRESHOLD = 80;

        function resetSwipeState(withTransition = true) {
          if (!main) return;
          if (withTransition) {
            main.style.transition = 'transform .2s ease';
          } else {
            main.style.transition = '';
          }
          main.style.transform = '';
          if (decisionBadge) {
            decisionBadge.classList.remove('active', 'keep', 'delete');
            decisionBadge.style.opacity = '0';
          }
          if (withTransition) {
            window.setTimeout(() => { if (main) main.style.transition = ''; }, 200);
          }
        }

        function handleMobileChange(event) {
          if (!event.matches) {
            resetSwipeState(false);
            swipeHint?.classList.remove('dismissed');
          }
        }

        if (typeof mobileMedia.addEventListener === 'function') {
          mobileMedia.addEventListener('change', handleMobileChange);
        } else if (typeof mobileMedia.addListener === 'function') {
          mobileMedia.addListener(handleMobileChange);
        }

        main.addEventListener('pointerdown', (event) => {
          if (!mobileMedia.matches) return;
          if (event.pointerType === 'mouse' && event.button !== 0) return;
          dragging = true;
          pointerId = event.pointerId;
          startX = event.clientX;
          startY = event.clientY;
          startTime = performance.now();
          swipeHint?.classList.add('dismissed');
          main.style.transition = '';
          try { main.setPointerCapture(pointerId); } catch (err) {}
        });

        main.addEventListener('pointermove', (event) => {
          if (!dragging || event.pointerId !== pointerId) return;
          const dx = event.clientX - startX;
          const dy = event.clientY - startY;

          if (Math.abs(dx) < 2 && Math.abs(dy) < 2) return;

          const rotate = Math.max(-25, Math.min(25, dx / 12));
          main.style.transform = `translateX(${dx}px) rotate(${rotate}deg)`;

          if (decisionBadge) {
            if (dx > 0) {
              decisionBadge.textContent = 'Keep';
              decisionBadge.classList.add('keep');
              decisionBadge.classList.remove('delete');
            } else if (dx < 0) {
              decisionBadge.textContent = 'Delete';
              decisionBadge.classList.add('delete');
              decisionBadge.classList.remove('keep');
            } else {
              decisionBadge.classList.remove('keep', 'delete');
            }
            const intensity = Math.min(1, Math.abs(dx) / SWIPE_THRESHOLD);
            if (Math.abs(dx) > 10) {
              decisionBadge.classList.add('active');
              decisionBadge.style.opacity = String(Math.min(0.95, 0.2 + intensity * 0.8));
            } else {
              decisionBadge.classList.remove('active');
              decisionBadge.style.opacity = '0';
            }
          }
        });

        function completeSwipe(event, cancelled = false) {
          if (!dragging || event.pointerId !== pointerId) return;
          dragging = false;
          try { main.releasePointerCapture(pointerId); } catch (err) {}

          const dx = event.clientX - startX;
          const dy = event.clientY - startY;
          const elapsed = performance.now() - startTime;
          const absDx = Math.abs(dx);
          const absDy = Math.abs(dy);

          let decision = null;
          if (!cancelled && absDx > absDy && (absDx > SWIPE_THRESHOLD || (absDx > 45 && elapsed < 180))) {
            decision = dx > 0 ? 'keep' : 'delete';
          }

          if (decision) {
            const direction = dx > 0 ? 1 : -1;
            main.style.transition = 'transform .25s ease';
            main.style.transform = `translateX(${direction * window.innerWidth}px) rotate(${direction * 30}deg)`;
            if (decisionBadge) {
              decisionBadge.textContent = decision === 'keep' ? 'Keep' : 'Delete';
              decisionBadge.classList.add('active');
              decisionBadge.classList.toggle('keep', decision === 'keep');
              decisionBadge.classList.toggle('delete', decision === 'delete');
              decisionBadge.style.opacity = '0.95';
            }
            window.setTimeout(() => {
              resetSwipeState(false);
              decide(decision);
            }, 220);
          } else {
            resetSwipeState(true);
          }
        }

        main.addEventListener('pointerup', (event) => completeSwipe(event, false));
        main.addEventListener('pointercancel', (event) => completeSwipe(event, true));
        main.addEventListener('pointerleave', (event) => completeSwipe(event, true));
      }
    })();
  </script>
{% endblock %}
