{% extends 'base.html' %}
{% block title %}{{ title }}{% if year %} ({{ year }}){% endif %} · Gallery · KWC{% endblock %}

{% block content %}
  <style>
    .crumb-link { display: inline-flex; align-items: center; gap: .35rem; color: var(--muted); margin-bottom: 1.5rem; font-weight: 600; }
    .crumb-link:hover { color: var(--text); }
    .gallery-layout {
      display: grid;
      gap: 2rem;
      padding: 0 clamp(1rem, 4vw, 2.5rem);
      box-sizing: border-box;
    }
    .gallery-header { display: grid; grid-template-columns: auto 1fr; gap: 1.5rem; align-items: center; }
    .gallery-cover { width: min(220px, 30vw); aspect-ratio: 2 / 3; border-radius: 1rem; overflow: hidden; position: relative; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); }
    .gallery-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .gallery-cover-empty { position: absolute; inset: 0; display: grid; place-items: center; color: var(--muted); font-weight: 600; }
    .gallery-meta { display: grid; gap: .6rem; }
    .gallery-meta h1 { margin: 0; font-size: clamp(1.75rem, 3vw, 2.4rem); }
    .gallery-details { display: flex; flex-wrap: wrap; align-items: center; gap: .6rem; color: var(--muted); }
    .gallery-count { font-size: .95rem; padding: .25rem .6rem; border-radius: 999px; background: rgba(124,76,245,0.18); color: #d1c5ff; font-weight: 600; }
  .gallery-actions { display: flex; flex-wrap: wrap; gap: .6rem; margin-top: .5rem; }
  .gallery-section { margin-bottom: 1.75rem; transition: margin-bottom 0.2s ease; }
  .gallery-section.is-collapsed { margin-bottom: 0.85rem; }
  .gallery-section:last-child { margin-bottom: 0; }
  .gallery-section-header { width: 100%; display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 0.75rem; cursor: pointer; transition: all 0.15s ease; margin-bottom: 1rem; color: var(--text); }
  .gallery-section-header:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.15); }
  .gallery-section-header[aria-expanded="false"] { margin-bottom: 0; }
  .gallery-section-title { font-size: 1.15rem; font-weight: 600; flex: 1; text-align: left; }
  .gallery-section-count { font-size: 0.9rem; padding: 0.25rem 0.6rem; border-radius: 999px; background: rgba(124,76,245,0.18); color: #d1c5ff; font-weight: 600; }
  .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.875rem; }
  .gallery-section-arrow { font-size: 0.85rem; color: var(--muted); transition: transform 0.2s ease; }
  .gallery-section-header[aria-expanded="false"] .gallery-section-arrow { transform: rotate(-90deg); }
  .gallery-section-content { overflow: hidden; transition: max-height 0.3s ease, opacity 0.2s ease; }
  .gallery-section-header[aria-expanded="false"] + .gallery-section-content { max-height: 0; opacity: 0; }
  .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.1rem; }
  .gallery-thumb { position: relative; border: 1px solid rgba(255,255,255,0.08); border-radius: .9rem; overflow: hidden; padding: 0; cursor: pointer; background: rgba(255,255,255,0.04); transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease; aspect-ratio: 16 / 9; display: grid; text-decoration: none; color: inherit; }
  .gallery-thumb:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.18); box-shadow: 0 12px 30px rgba(0,0,0,0.25); }
  .gallery-thumb-img { display: block; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity .25s ease; }
  .gallery-thumb.loading .gallery-thumb-img { opacity: 0; }
  .gallery-thumb-img.loaded { opacity: 1; }
  .gallery-thumb:focus-visible { outline: 2px solid var(--accent); outline-offset: 4px; }
  .gallery-empty { margin-top: 2rem; color: var(--muted); font-size: 1.05rem; }
  .gallery-thumb .spinner { position: absolute; inset: 0; display: grid; place-items: center; }
  .gallery-thumb:not(.loading) .spinner { display: none; }
  .spinner::before { content: ""; width: 22px; height: 22px; border-radius: 999px; border: 2px solid rgba(255,255,255,0.35); border-top-color: #fff; animation: spin .9s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .version-badge { position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(124,76,245,0.9); color: white; font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.5rem; border-radius: 999px; pointer-events: none; }

    @media (max-width: 960px) {
      .gallery-header { grid-template-columns: 1fr; }
      .gallery-cover { width: clamp(160px, 45vw, 220px); justify-self: center; }
      .gallery-meta { text-align: center; }
      .gallery-details { justify-content: center; text-align: center; }
      .gallery-actions { justify-content: center; }
    }

    @media (max-width: 640px) {
      .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: .85rem; }
      .gallery-thumb { border-radius: .7rem; }
    }
  </style>

  <div class="gallery-layout">
    <a href="{% url 'home' %}" class="crumb-link">← Back to library</a>

    <div class="gallery-header">
      <div class="gallery-cover">
        {% if cover_url %}
         <img src="{{ cover_thumb_url|default:cover_url }}" alt="{{ title }} cover" />
        {% else %}
          <div class="gallery-cover-empty">No cover</div>
        {% endif %}
      </div>
      <div class="gallery-meta">
  <h1>{{ title }}</h1>
        <div class="gallery-details">
          {% if year %}<span>{{ year }}</span>{% endif %}
          <span class="gallery-count">{{ images|length }} image{% if images|length != 1 %}s{% endif %}</span>
        </div>
        {% if is_inbox %}
          <div class="gallery-actions">
            {% if sections|length <= 1 %}
              <a class="btn btn-primary" href="{{ choose_url }}">Choose</a>
            {% endif %}
            <form action="{% url 'choose:inbox_delete' folder=folder %}" method="post" style="display: flex;">
              {% csrf_token %}
              <button type="submit" class="btn" style="background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.25);" onclick="return confirm('Are you sure you want to delete this folder permanently? This cannot be undone.');">Delete folder</button>
            </form>
          </div>
        {% endif %}
      </div>
    </div>

    {% if images %}
      {% if sections|length > 1 %}
        {# Series with multiple sections - show grouped view #}
        {% for section in sections %}
          <div class="gallery-section">
            <button class="gallery-section-header" type="button" data-section-toggle aria-expanded="true">
              <span class="gallery-section-title">{{ section.title }}</span>
              <span class="gallery-section-count">{{ section.images|length }} image{% if section.images|length != 1 %}s{% endif %}</span>
              <a class="btn btn-primary btn-sm" href="{{ section.choose_url }}" style="margin-left: auto; margin-right: 0.5rem;" onclick="event.stopPropagation();">Choose</a>
              <span class="gallery-section-arrow" aria-hidden="true">▼</span>
            </button>
            <div class="gallery-section-content" data-section-content>
              <div class="gallery-grid">
                {% for image in section.images %}
                  <a class="gallery-thumb loading{% if image.versions|length > 1 %} has-versions{% endif %}" 
                    href="{% if is_inbox %}{% url 'choose:inbox_lightbox' folder=folder filename=image.name %}{% else %}{% url 'choose:lightbox' folder=folder filename=image.name %}{% endif %}"
                    aria-label="View {{ image.name }} full screen">
                    <div class="spinner" aria-hidden="true"></div>
                    <img class="gallery-thumb-img" src="{{ image.thumb_url|default:image.url }}" alt="{{ title }} – {{ image.name }}" loading="lazy" decoding="async" onload="this.classList.add('loaded'); this.closest('.gallery-thumb')?.classList.remove('loading');" onerror="this.closest('.gallery-thumb')?.classList.remove('loading'); this.classList.add('loaded'); this.style.opacity='0.35';" />
                    {% if image.versions|length > 1 %}
                      <span class="version-badge" aria-label="{{ image.versions|length }} versions">{{ image.versions|length }}</span>
                    {% endif %}
                  </a>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        {# Single section or movie - show flat view #}
        <div class="gallery-grid">
          {% for image in images %}
            <a class="gallery-thumb loading{% if image.versions|length > 1 %} has-versions{% endif %}" 
              href="{% if is_inbox %}{% url 'choose:inbox_lightbox' folder=folder filename=image.name %}{% else %}{% url 'choose:lightbox' folder=folder filename=image.name %}{% endif %}"
              aria-label="View {{ image.name }} full screen">
              <div class="spinner" aria-hidden="true"></div>
              <img class="gallery-thumb-img" src="{{ image.thumb_url|default:image.url }}" alt="{{ title }} – {{ image.name }}" loading="lazy" decoding="async" onload="this.classList.add('loaded'); this.closest('.gallery-thumb')?.classList.remove('loading');" onerror="this.closest('.gallery-thumb')?.classList.remove('loading'); this.classList.add('loaded'); this.style.opacity='0.35';" />
              {% if image.versions|length > 1 %}
                <span class="version-badge" aria-label="{{ image.versions|length }} versions">{{ image.versions|length }}</span>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% endif %}
    {% else %}
      <p class="gallery-empty">No wallpapers were found in this folder. Try running a new extraction.</p>
    {% endif %}
  </div>

  <script>
    // Section collapse/expand functionality
    (function () {
      const toggleButtons = document.querySelectorAll('[data-section-toggle]');

      toggleButtons.forEach(function (button) {
        const section = button.closest('.gallery-section');
        if (!section) {
          return;
        }

        function syncSectionState(isExpanded) {
          section.classList.toggle('is-collapsed', !isExpanded);
        }

        const initialExpanded = button.getAttribute('aria-expanded') !== 'false';
        syncSectionState(initialExpanded);

        button.addEventListener('click', function () {
          const isExpanded = button.getAttribute('aria-expanded') === 'true';
          const nextExpanded = !isExpanded;
          button.setAttribute('aria-expanded', nextExpanded ? 'true' : 'false');
          syncSectionState(nextExpanded);
        });
      });
    })();
  </script>
{% endblock %}
