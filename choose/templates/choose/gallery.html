{% extends 'base.html' %}
{% block title %}{{ title }}{% if year %} ({{ year }}){% endif %} · Gallery · KWC{% endblock %}

{% block content %}
  <style>
    .crumb-link { display: inline-flex; align-items: center; gap: .35rem; color: var(--muted); margin-bottom: 1.5rem; font-weight: 600; }
    .crumb-link:hover { color: var(--text); }
    .gallery-layout { display: grid; gap: 2rem; }
    .gallery-header { display: grid; grid-template-columns: auto 1fr; gap: 1.5rem; align-items: center; }
    .gallery-cover { width: min(220px, 30vw); aspect-ratio: 2 / 3; border-radius: 1rem; overflow: hidden; position: relative; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); }
    .gallery-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .gallery-cover-empty { position: absolute; inset: 0; display: grid; place-items: center; color: var(--muted); font-weight: 600; }
    .gallery-meta { display: grid; gap: .6rem; }
    .gallery-meta h1 { margin: 0; font-size: clamp(1.75rem, 3vw, 2.4rem); }
    .gallery-details { display: flex; flex-wrap: wrap; align-items: center; gap: .6rem; color: var(--muted); }
    .gallery-count { font-size: .95rem; padding: .25rem .6rem; border-radius: 999px; background: rgba(124,76,245,0.18); color: #d1c5ff; font-weight: 600; }
  .gallery-actions { display: flex; flex-wrap: wrap; gap: .6rem; margin-top: .5rem; }
  .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.1rem; }
  .gallery-thumb { position: relative; border: 1px solid rgba(255,255,255,0.08); border-radius: .9rem; overflow: hidden; padding: 0; cursor: zoom-in; background: rgba(255,255,255,0.04); transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease; aspect-ratio: 16 / 9; display: grid; }
  .gallery-thumb:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.18); box-shadow: 0 12px 30px rgba(0,0,0,0.25); }
  .gallery-thumb-img { display: block; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity .25s ease; }
  .gallery-thumb.loading .gallery-thumb-img { opacity: 0; }
  .gallery-thumb-img.loaded { opacity: 1; }
  .gallery-thumb:focus-visible { outline: 2px solid var(--accent); outline-offset: 4px; }
  .gallery-empty { margin-top: 2rem; color: var(--muted); font-size: 1.05rem; }
  .gallery-thumb .spinner { position: absolute; inset: 0; display: grid; place-items: center; }
  .gallery-thumb:not(.loading) .spinner { display: none; }
  .spinner::before { content: ""; width: 22px; height: 22px; border-radius: 999px; border: 2px solid rgba(255,255,255,0.35); border-top-color: #fff; animation: spin .9s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

    .lightbox { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(6, 9, 20, 0.92); z-index: 2000; padding: 2.5rem 2rem; }
    .lightbox.is-open { display: flex; }
    .lightbox::backdrop { background: rgba(6, 9, 20, 0.92); }
    .lightbox-inner { position: relative; display: grid; gap: 1rem; max-width: min(96vw, 1600px); width: 100%; }
  .lightbox-media { position: relative; display: grid; place-items: center; max-height: calc(90vh - 140px); }
  .lightbox-media img { width: 100%; height: 100%; object-fit: contain; border-radius: 1rem; box-shadow: 0 18px 40px rgba(0,0,0,0.45); background: rgba(0,0,0,0.4); opacity: 0; transition: opacity .25s ease; }
  .lightbox-media img.loaded { opacity: 1; }
  .lightbox-spinner { position: absolute; inset: 0; display: grid; place-items: center; }
  .lightbox-media:not(.is-loading) .lightbox-spinner { display: none; }
    .lightbox-footer { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: .75rem; }
    .lightbox-caption { font-weight: 600; word-break: break-word; }
    .lightbox-buttons { display: inline-flex; gap: .5rem; }
    .lightbox-close, .lightbox-prev, .lightbox-next { position: absolute; top: 1rem; width: 2.75rem; height: 2.75rem; border-radius: 999px; border: 1px solid rgba(255,255,255,0.18); background: rgba(26,32,56,0.85); color: #fff; display: grid; place-items: center; font-size: 1.4rem; font-weight: 700; cursor: pointer; }
    .lightbox-close { right: 1rem; }
    .lightbox-prev { left: 1rem; top: 50%; transform: translateY(-50%); }
    .lightbox-next { right: 1rem; top: 50%; transform: translateY(-50%); }
    .lightbox-close:hover, .lightbox-prev:hover, .lightbox-next:hover { background: rgba(44,52,88,0.9); border-color: rgba(255,255,255,0.35); }
    .lightbox-prev[disabled], .lightbox-next[disabled] { opacity: .35; cursor: not-allowed; }

    @media (max-width: 960px) {
      .gallery-header { grid-template-columns: 1fr; }
      .gallery-cover { width: clamp(160px, 45vw, 220px); justify-self: center; }
      .gallery-meta { text-align: center; }
      .gallery-actions { justify-content: center; }
      .lightbox { padding: 1.5rem 1rem; }
      .lightbox-close { top: .75rem; right: .75rem; }
      .lightbox-prev, .lightbox-next { display: none; }
    }

    @media (max-width: 640px) {
      .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: .85rem; }
      .gallery-thumb { border-radius: .7rem; }
    }
  </style>

  <div class="gallery-layout">
    <a href="{% url 'home' %}" class="crumb-link">← Back to library</a>

    <div class="gallery-header">
      <div class="gallery-cover">
        {% if cover_url %}
         <img src="{{ cover_thumb_url|default:cover_url }}" alt="{{ title }} cover" />
        {% else %}
          <div class="gallery-cover-empty">No cover</div>
        {% endif %}
      </div>
      <div class="gallery-meta">
        <h1>{{ title }}{% if year %} <span style="color: var(--muted);">({{ year }})</span>{% endif %}</h1>
        <div class="gallery-details">
          {% if year %}<span>{{ year }}</span>{% endif %}
          <span class="gallery-count">{{ images|length }} image{% if images|length != 1 %}s{% endif %}</span>
        </div>
        <div class="gallery-actions">
          <a class="btn btn-primary" href="{{ choose_url }}">Choose</a>
        </div>
      </div>
    </div>

    {% if images %}
      <div class="gallery-grid">
        {% for image in images %}
          <button class="gallery-thumb loading" type="button" data-gallery-thumb data-src="{{ image.url }}" data-name="{{ image.name }}" aria-label="View {{ image.name }} full screen">
            <div class="spinner" aria-hidden="true"></div>
              <img class="gallery-thumb-img" src="{{ image.thumb_url|default:image.url }}" alt="{{ title }} – {{ image.name }}" loading="lazy" decoding="async" onload="this.classList.add('loaded'); this.closest('.gallery-thumb')?.classList.remove('loading');" onerror="this.closest('.gallery-thumb')?.classList.remove('loading'); this.classList.add('loaded'); this.style.opacity='0.35';" />
          </button>
        {% endfor %}
      </div>
    {% else %}
      <p class="gallery-empty">No wallpapers were found in this folder. Try running a new extraction.</p>
    {% endif %}
  </div>

  {% if images %}
    <div class="lightbox" id="gallery-lightbox" aria-hidden="true" role="dialog">
      <div class="lightbox-inner">
        <div class="lightbox-media is-loading">
          <div class="lightbox-spinner spinner" aria-hidden="true"></div>
          <img id="lightbox-image" src="" alt="" decoding="async" />
        </div>
        <div class="lightbox-footer">
          <div class="lightbox-caption">
            <span id="lightbox-index"></span>
            <strong id="lightbox-name"></strong>
          </div>
          <div class="lightbox-buttons">
            <a id="lightbox-download" class="btn btn-primary" href="#" download>Download</a>
          </div>
        </div>
        <button class="lightbox-close" type="button" aria-label="Close viewer">×</button>
        <button class="lightbox-prev" type="button" aria-label="Previous image">‹</button>
        <button class="lightbox-next" type="button" aria-label="Next image">›</button>
      </div>
    </div>

    <script>
      (function () {
        const thumbs = Array.from(document.querySelectorAll('[data-gallery-thumb]'));
        if (!thumbs.length) {
          return;
        }

  const lightbox = document.getElementById('gallery-lightbox');
  const image = document.getElementById('lightbox-image');
        const nameEl = document.getElementById('lightbox-name');
        const indexEl = document.getElementById('lightbox-index');
        const downloadLink = document.getElementById('lightbox-download');
        const closeBtn = lightbox.querySelector('.lightbox-close');
        const prevBtn = lightbox.querySelector('.lightbox-prev');
        const nextBtn = lightbox.querySelector('.lightbox-next');
  const lightboxMedia = lightbox.querySelector('.lightbox-media');

  let current = -1;
  let lastTrigger = null;

        function updateNavButtons() {
          const disableNav = thumbs.length <= 1;
          if (prevBtn) prevBtn.disabled = disableNav;
          if (nextBtn) nextBtn.disabled = disableNav;
        }

        function open(index) {
          const target = thumbs[index];
          if (!target) {
            return;
          }
          current = index;
          lastTrigger = target;
          const src = target.getAttribute('data-src');
          const filename = target.getAttribute('data-name') || '';

          const handleLoad = () => {
            image.classList.add('loaded');
            lightboxMedia?.classList.remove('is-loading');
          };
          const handleError = () => {
            lightboxMedia?.classList.remove('is-loading');
          };

          image.classList.remove('loaded');
          lightboxMedia?.classList.add('is-loading');
          image.onload = handleLoad;
          image.onerror = handleError;

          image.src = src;
          image.alt = filename ? `${filename} preview` : 'Wallpaper preview';
          nameEl.textContent = filename;
          indexEl.textContent = `${index + 1} / ${thumbs.length} · `;
          downloadLink.href = src;
          if (filename) {
            downloadLink.setAttribute('download', filename);
          } else {
            downloadLink.removeAttribute('download');
          }

          lightbox.classList.add('is-open');
          lightbox.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';
          closeBtn.focus({ preventScroll: true });

          if (image.complete && image.naturalWidth > 0) {
            handleLoad();
          }
        }

        function close() {
          current = -1;
          lightbox.classList.remove('is-open');
          lightbox.setAttribute('aria-hidden', 'true');
          image.onload = null;
          image.onerror = null;
          image.classList.remove('loaded');
          image.src = '';
          lightboxMedia?.classList.remove('is-loading');
          document.body.style.overflow = '';
          if (lastTrigger) {
            lastTrigger.focus({ preventScroll: true });
          }
        }

        function step(delta) {
          if (!thumbs.length) {
            return;
          }
          const nextIndex = (current + delta + thumbs.length) % thumbs.length;
          open(nextIndex);
        }

        updateNavButtons();

        thumbs.forEach(function (button, index) {
          button.addEventListener('click', function () {
            open(index);
          });
          button.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              open(index);
            }
          });
        });

        lightbox.addEventListener('click', function (event) {
          if (event.target === lightbox) {
            close();
          }
        });

        if (closeBtn) {
          closeBtn.addEventListener('click', close);
        }
        if (prevBtn) {
          prevBtn.addEventListener('click', function () { step(-1); });
        }
        if (nextBtn) {
          nextBtn.addEventListener('click', function () { step(1); });
        }

        document.addEventListener('keydown', function (event) {
          if (!lightbox.classList.contains('is-open')) {
            return;
          }
          if (event.key === 'Escape') {
            close();
            return;
          }
          if (event.key === 'ArrowLeft') {
            step(-1);
            event.preventDefault();
            return;
          }
          if (event.key === 'ArrowRight') {
            step(1);
            event.preventDefault();
          }
        });
      })();
    </script>
  {% endif %}
{% endblock %}
